"""
AEGIS Malware Signature & Behavioral Database
Comprehensive threat intelligence for detecting 25+ major malware families
"""

from dataclasses import dataclass
from typing import List, Dict, Set
from enum import Enum


class ThreatCategory(Enum):
    RANSOMWARE = "ransomware"
    INFOSTEALER = "infostealer"
    TROJAN = "trojan"
    RAT = "rat"
    CRYPTOMINER = "cryptominer"
    DOWNLOADER = "downloader"
    WORM = "worm"
    BACKDOOR = "backdoor"
    WIPER = "wiper"
    CYBERWEAPON = "cyberweapon"


class ThreatSeverity(Enum):
    CRITICAL = 10
    HIGH = 8
    MEDIUM = 6
    LOW = 4


@dataclass
class BehavioralIndicator:
    """Behavioral patterns that indicate malicious activity"""
    name: str
    description: str
    iocs: List[str]  # Indicators of Compromise
    weight: float  # 0.0 to 1.0, how strong this indicator is


@dataclass
class MalwareSignature:
    """Complete signature profile for a malware family"""
    name: str
    aliases: List[str]
    category: ThreatCategory
    severity: ThreatSeverity
    description: str

    # Behavioral indicators
    behaviors: List[BehavioralIndicator]

    # Technical characteristics
    languages: List[str]  # Programming languages used
    attack_vectors: List[str]
    persistence_methods: List[str]
    evasion_techniques: List[str]

    # IOCs
    file_extensions: List[str]
    registry_keys: List[str]
    network_iocs: List[str]
    process_names: List[str]

    # Kill chain stages
    initial_access: str
    execution: str
    persistence: str
    privilege_escalation: str
    defense_evasion: str
    credential_access: str
    discovery: str
    lateral_movement: str
    collection: str
    exfiltration: str
    impact: str


# ============================================================================
# MALWARE DATABASE - All 25+ Threats from the Gemini Conversation
# ============================================================================

MALWARE_DATABASE = {

    # ========================================================================
    # RANSOMWARE FAMILIES
    # ========================================================================

    "RansomHub": MalwareSignature(
        name="RansomHub",
        aliases=["Knight", "Cyclops"],
        category=ThreatCategory.RANSOMWARE,
        severity=ThreatSeverity.CRITICAL,
        description="RaaS operation, emerged 2024, 90% affiliate cut, double extortion",

        behaviors=[
            BehavioralIndicator(
                name="EDR Killer",
                description="Uses BYOVD attack (EDRKillShifter) to disable security tools",
                iocs=["driver load", "security software termination", "safe mode boot"],
                weight=0.9
            ),
            BehavioralIndicator(
                name="Backup Deletion",
                description="Deletes Volume Shadow Copies",
                iocs=["vssadmin delete shadows", "wmic shadowcopy delete"],
                weight=0.95
            ),
            BehavioralIndicator(
                name="Intermittent Encryption",
                description="Only encrypts chunks of large files for speed",
                iocs=["partial file encryption", "rapid file modification"],
                weight=0.8
            ),
        ],

        languages=["Go", "C++"],
        attack_vectors=["Phishing", "Exploits (Citrix, FortiOS)", "Initial Access Brokers"],
        persistence_methods=["Registry Run keys", "Scheduled tasks"],
        evasion_techniques=["Gobfuscate", "BYOVD", "Safe Mode execution"],

        file_extensions=[".ransomnote", ".encrypted"],
        registry_keys=["HKLM\\System\\CurrentControlSet\\Services"],
        network_iocs=["Rclone traffic", "Tor connections"],
        process_names=["vssadmin.exe", "wmic.exe"],

        initial_access="Phishing emails, exploiting vulnerabilities, stolen credentials",
        execution="Malicious executable",
        persistence="Registry modification, scheduled tasks",
        privilege_escalation="BYOVD exploitation",
        defense_evasion="Disable AV/EDR, Safe Mode, Gobfuscate",
        credential_access="N/A",
        discovery="Network scanning",
        lateral_movement="SMB, RDP",
        collection="File enumeration",
        exfiltration="Rclone, WinSCP to C2",
        impact="File encryption, ransom demand"
    ),

    "Cl0p": MalwareSignature(
        name="Cl0p",
        aliases=["Clop"],
        category=ThreatCategory.RANSOMWARE,
        severity=ThreatSeverity.CRITICAL,
        description="Mass exploitation of zero-days (MOVEit, Cleo), triple extortion",

        behaviors=[
            BehavioralIndicator(
                name="Zero-Day Exploitation",
                description="Exploits unknown vulnerabilities in MFT software",
                iocs=["SQL injection patterns", "web shell deployment", "LEMURLOOT"],
                weight=1.0
            ),
            BehavioralIndicator(
                name="Encryption-less Extortion",
                description="Steals data without encrypting (smash and grab)",
                iocs=["massive data exfiltration", "no encryption activity"],
                weight=0.85
            ),
        ],

        languages=["C++", "PHP"],
        attack_vectors=["Zero-day exploits in MFT software"],
        persistence_methods=["Web shells"],
        evasion_techniques=["Legitimate software exploitation"],

        file_extensions=[".Clop"],
        registry_keys=[],
        network_iocs=["evil-server.com patterns", "mass file uploads"],
        process_names=["human2.aspx", "LEMURLOOT.aspx"],

        initial_access="Zero-day exploitation (MOVEit, Cleo, Oracle)",
        execution="Web shell",
        persistence="Web shell backdoor",
        privilege_escalation="SQL injection",
        defense_evasion="Legitimate software abuse",
        credential_access="Database access",
        discovery="Automated scanning",
        lateral_movement="N/A (mass exploitation)",
        collection="Automated file harvesting",
        exfiltration="Direct download via web shell",
        impact="Data theft, extortion, DDoS"
    ),

    "Akira": MalwareSignature(
        name="Akira",
        aliases=["Megazord"],
        category=ThreatCategory.RANSOMWARE,
        severity=ThreatSeverity.CRITICAL,
        description="Targets VPNs without MFA, cross-platform (Windows/Linux), Conti successor",

        behaviors=[
            BehavioralIndicator(
                name="VPN Exploitation",
                description="Targets Cisco ASA/FTD VPNs without MFA",
                iocs=["VPN authentication attempts", "no MFA enforcement"],
                weight=0.9
            ),
            BehavioralIndicator(
                name="ESXi Targeting",
                description="Rust variant targets VMware ESXi",
                iocs=["ESXi command execution", "VM encryption"],
                weight=0.95
            ),
        ],

        languages=["C++", "Rust"],
        attack_vectors=["VPN credential abuse", "Cisco ASA/FTD exploitation"],
        persistence_methods=["Custom backdoor"],
        evasion_techniques=["BYOVD (PowerTool)", "Mimikatz for creds"],

        file_extensions=[".akira"],
        registry_keys=[],
        network_iocs=["WinSCP", "Rclone traffic"],
        process_names=["mimikatz.exe"],

        initial_access="Compromised VPN credentials (no MFA)",
        execution="Malicious binary",
        persistence="Custom backdoor",
        privilege_escalation="Mimikatz credential theft",
        defense_evasion="BYOVD to kill AV/EDR",
        credential_access="Mimikatz",
        discovery="Network enumeration",
        lateral_movement="Stolen credentials",
        collection="Pre-encryption data theft",
        exfiltration="WinSCP, Rclone",
        impact="Cross-platform encryption (Windows + ESXi)"
    ),

    "LockBit": MalwareSignature(
        name="LockBit",
        aliases=["LockBit Black", "LockBit 5.0", "ABCD"],
        category=ThreatCategory.RANSOMWARE,
        severity=ThreatSeverity.CRITICAL,
        description="Most prolific RaaS, 40% of all ransomware attacks, self-spreading worm",

        behaviors=[
            BehavioralIndicator(
                name="Printer Ransom Notes",
                description="Sends ransom note to all network printers",
                iocs=["mass printer jobs", "ransom note printing"],
                weight=0.75
            ),
            BehavioralIndicator(
                name="Self-Spreading Worm",
                description="Uses Group Policy to spread across network",
                iocs=["GPO modification", "automated lateral movement"],
                weight=0.9
            ),
            BehavioralIndicator(
                name="Password-Protected Execution",
                description="Requires password to run (anti-analysis)",
                iocs=["execution requires password"],
                weight=0.7
            ),
        ],

        languages=["C++"],
        attack_vectors=["Phishing", "Exploits", "Initial Access Brokers"],
        persistence_methods=["Registry", "Scheduled tasks", "Group Policy"],
        evasion_techniques=["Password protection", "Disable Defender", "Anti-VM"],

        file_extensions=[".lockbit", ".abcd"],
        registry_keys=["HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows Defender"],
        network_iocs=["Tor C2", "StealBit exfiltration"],
        process_names=["conhost.exe", "gpupdate.exe"],

        initial_access="Phishing, exploits, stolen credentials",
        execution="Password-protected executable",
        persistence="Group Policy, registry",
        privilege_escalation="Stolen admin credentials",
        defense_evasion="Disable Windows Defender, password protection",
        credential_access="Credential harvesting",
        discovery="Network scanning, AD enumeration",
        lateral_movement="Group Policy push, SMB",
        collection="StealBit tool",
        exfiltration="Automated exfiltration to C2",
        impact="File encryption, printer spam, double extortion"
    ),

    # ========================================================================
    # INFO-STEALERS
    # ========================================================================

    "Agent Tesla": MalwareSignature(
        name="Agent Tesla",
        aliases=["AgentTesla"],
        category=ThreatCategory.INFOSTEALER,
        severity=ThreatSeverity.HIGH,
        description=".NET info-stealer, MaaS model, keylogger + credential theft",

        behaviors=[
            BehavioralIndicator(
                name="Keylogging",
                description="Records all keystrokes",
                iocs=["keyboard hook", "keystroke logging"],
                weight=0.9
            ),
            BehavioralIndicator(
                name="Browser Credential Theft",
                description="Steals saved passwords from 50+ applications",
                iocs=["browser data access", "credential file reading"],
                weight=0.95
            ),
            BehavioralIndicator(
                name="Multi-Stage Infection",
                description="VBA macro -> PowerShell -> .NET DLL injection",
                iocs=["macro execution", "PowerShell obfuscation", "process hollowing"],
                weight=0.85
            ),
        ],

        languages=[".NET", "VBA"],
        attack_vectors=["Phishing emails with malicious attachments"],
        persistence_methods=["Registry Run keys", "Scheduled tasks"],
        evasion_techniques=["Process hollowing", "fileless execution", "obfuscation"],

        file_extensions=[".exe", ".dll"],
        registry_keys=["HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"],
        network_iocs=["SMTP exfiltration", "FTP uploads", "Telegram API"],
        process_names=["RegAsm.exe", "explorer.exe"],

        initial_access="Phishing with malicious Word/Excel document",
        execution="VBA macro -> PowerShell -> injected .NET DLL",
        persistence="Registry Run key",
        privilege_escalation="N/A",
        defense_evasion="Process injection into RegAsm.exe",
        credential_access="Keylogging, browser data theft",
        discovery="Application enumeration",
        lateral_movement="N/A",
        collection="Keystrokes, credentials, screenshots",
        exfiltration="SMTP, FTP, HTTP, Telegram",
        impact="Data theft"
    ),

    "Jupyter": MalwareSignature(
        name="Jupyter",
        aliases=["SolarMarker", "Polazert", "Yellow Cockatoo"],
        category=ThreatCategory.INFOSTEALER,
        severity=ThreatSeverity.HIGH,
        description="SEO poisoning, fileless, browser credential theft, .NET backdoor",

        behaviors=[
            BehavioralIndicator(
                name="SEO Poisoning",
                description="Fake websites in Google search results",
                iocs=["download from typosquatted domain", "malvertising"],
                weight=0.8
            ),
            BehavioralIndicator(
                name="Fileless Reflective Loading",
                description="Loads .NET DLL directly into memory via PowerShell",
                iocs=["PowerShell reflective load", "no .exe on disk"],
                weight=0.95
            ),
        ],

        languages=[".NET", "PowerShell"],
        attack_vectors=["SEO poisoning", "Malvertising"],
        persistence_methods=[".LNK file in StartUp folder"],
        evasion_techniques=["Fileless", "Large MSI files", "Signed with stolen cert"],

        file_extensions=[".msi"],
        registry_keys=[],
        network_iocs=["C2 via DNS-over-HTTPS"],
        process_names=["powershell.exe"],

        initial_access="SEO poisoning (fake software download)",
        execution="MSI installer -> PowerShell script",
        persistence=".LNK file in StartUp folder",
        privilege_escalation="N/A",
        defense_evasion="Fileless, reflective DLL loading",
        credential_access="Browser credential theft",
        discovery="Browser enumeration",
        lateral_movement="N/A",
        collection="Cookies, passwords, credit cards",
        exfiltration="Encrypted C2 traffic",
        impact="Credential theft, backdoor for ransomware"
    ),

    # ========================================================================
    # TROJANS & RATS
    # ========================================================================

    "DarkGate": MalwareSignature(
        name="DarkGate",
        aliases=[],
        category=ThreatCategory.TROJAN,
        severity=ThreatSeverity.HIGH,
        description="MaaS trojan/loader, hVNC, uses AutoIt for evasion, MS Teams vector",

        behaviors=[
            BehavioralIndicator(
                name="Microsoft Teams Phishing",
                description="Sends malicious files via Teams external chat",
                iocs=["Teams external message", "ZIP attachment"],
                weight=0.7
            ),
            BehavioralIndicator(
                name="Hidden Virtual Desktop (hVNC)",
                description="Creates invisible second desktop for attacker",
                iocs=["hidden VNC session", "second desktop creation"],
                weight=0.95
            ),
            BehavioralIndicator(
                name="AutoIt Abuse",
                description="Uses legitimate AutoIt3.exe to run malicious script",
                iocs=["AutoIt3.exe execution", "obfuscated .au3 script"],
                weight=0.9
            ),
        ],

        languages=["AutoIt"],
        attack_vectors=["Phishing", "MS Teams", "Malvertising"],
        persistence_methods=["Registry", "Scheduled tasks"],
        evasion_techniques=["AutoIt abuse", "In-memory execution"],

        file_extensions=[".zip", ".msi", ".vbs"],
        registry_keys=["HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"],
        network_iocs=["hVNC traffic", "C2 over HTTPS"],
        process_names=["Autoit3.exe"],

        initial_access="MS Teams phishing, malvertising",
        execution="AutoIt script",
        persistence="Registry Run key",
        privilege_escalation="UAC bypass modules",
        defense_evasion="AutoIt obfuscation, in-memory execution",
        credential_access="Browser theft, crypto wallet theft",
        discovery="System enumeration",
        lateral_movement="N/A",
        collection="Credentials, keystrokes, screenshots",
        exfiltration="C2 channel",
        impact="Full remote control via hVNC, ransomware loader"
    ),

    "Arechclient2": MalwareSignature(
        name="Arechclient2",
        aliases=["SectopRAT"],
        category=ThreatCategory.RAT,
        severity=ThreatSeverity.HIGH,
        description=".NET RAT, hVNC, fileless via AutoIt, cryptocurrency wallet theft",

        behaviors=[
            BehavioralIndicator(
                name="Hidden Virtual Desktop",
                description="hVNC allows invisible remote control",
                iocs=["hidden desktop session", "VNC traffic"],
                weight=0.95
            ),
            BehavioralIndicator(
                name="Cryptocurrency Wallet Theft",
                description="Searches for wallet.dat and crypto files",
                iocs=["wallet file search", "crypto folder access"],
                weight=0.85
            ),
        ],

        languages=[".NET", "AutoIt"],
        attack_vectors=["Malvertising", "SEO poisoning", "Phishing"],
        persistence_methods=["AutoIt script persistence"],
        evasion_techniques=["Fileless", "Process injection", "Anti-VM"],

        file_extensions=[],
        registry_keys=["HKLM\\SOFTWARE\\Microsoft\\Windows Defender\\Exclusions"],
        network_iocs=["Pastebin.com queries for C2", "Port 15647"],
        process_names=["msbuild.exe", "RegAsm.exe"],

        initial_access="Malvertising (fake software downloads)",
        execution="AutoIt -> injected .NET DLL",
        persistence="Malicious AutoIt script",
        privilege_escalation="UAC bypass",
        defense_evasion="Fileless, disable Windows Defender",
        credential_access="Browser, crypto wallet theft",
        discovery="System profiling",
        lateral_movement="N/A",
        collection="hVNC, credentials, files",
        exfiltration="AES-256 encrypted C2",
        impact="Data theft, ransomware precursor (BlackSuit)"
    ),

    "Ratenjay": MalwareSignature(
        name="Ratenjay",
        aliases=["njRAT", "Bladabindi"],
        category=ThreatCategory.RAT,
        severity=ThreatSeverity.MEDIUM,
        description=".NET commodity RAT, USB worm capability, webcam/mic access",

        behaviors=[
            BehavioralIndicator(
                name="USB Worm Propagation",
                description="Copies itself to USB drives with autorun",
                iocs=["USB file creation", "autorun.inf"],
                weight=0.8
            ),
            BehavioralIndicator(
                name="Webcam Spying",
                description="Activates webcam and microphone",
                iocs=["webcam access", "microphone access"],
                weight=0.9
            ),
        ],

        languages=[".NET"],
        attack_vectors=["Phishing", "Infected USB drives"],
        persistence_methods=["Registry Run key", "USB autorun"],
        evasion_techniques=["Firewall rule creation", "process name disguise"],

        file_extensions=[".exe"],
        registry_keys=["HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"],
        network_iocs=["Direct C2 connection"],
        process_names=["svchost.exe", "explorer.exe"],

        initial_access="Phishing or infected USB",
        execution=".NET executable",
        persistence="Registry + USB worm",
        privilege_escalation="N/A",
        defense_evasion="Process name disguise, firewall rule",
        credential_access="Keylogger, browser theft",
        discovery="Process enumeration",
        lateral_movement="USB worm",
        collection="Keystrokes, webcam, files",
        exfiltration="C2 channel",
        impact="Full remote control, espionage"
    ),

    "NanoCore": MalwareSignature(
        name="NanoCore",
        aliases=["Nanocore RAT"],
        category=ThreatCategory.RAT,
        severity=ThreatSeverity.MEDIUM,
        description=".NET plugin-based RAT, cracked version widespread, modular capabilities",

        behaviors=[
            BehavioralIndicator(
                name="Plugin Architecture",
                description="Loads plugins for different capabilities",
                iocs=["plugin download", "modular loading"],
                weight=0.8
            ),
            BehavioralIndicator(
                name="ISO File Delivery",
                description="Uses .iso files to bypass email scanners",
                iocs=[".iso file mount", "virtual drive creation"],
                weight=0.75
            ),
        ],

        languages=[".NET"],
        attack_vectors=["Phishing with ISO/LNK attachments"],
        persistence_methods=["Registry Run key"],
        evasion_techniques=["Process injection into RegAsm.exe"],

        file_extensions=[".iso", ".lnk"],
        registry_keys=["HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"],
        network_iocs=["Plugin C2 traffic"],
        process_names=["RegAsm.exe", "explorer.exe"],

        initial_access="Phishing (ISO or Office macro)",
        execution="Injected .NET DLL",
        persistence="Registry",
        privilege_escalation="N/A",
        defense_evasion="Process injection",
        credential_access="nPWD plugin, Advanced Vein plugin",
        discovery="System profiling",
        lateral_movement="N/A",
        collection="Plugins: keylogger, webcam, file manager",
        exfiltration="C2 channel",
        impact="Full remote control, can load ransomware plugin"
    ),

    # ========================================================================
    # DOWNLOADERS
    # ========================================================================

    "SocGholish": MalwareSignature(
        name="SocGholish",
        aliases=["FakeUpdates"],
        category=ThreatCategory.DOWNLOADER,
        severity=ThreatSeverity.HIGH,
        description="Fake browser update framework, compromised websites, delivers ransomware",

        behaviors=[
            BehavioralIndicator(
                name="Fake Browser Update",
                description="Displays fake Chrome/Firefox/Edge update prompt",
                iocs=["website overlay", "fake update prompt", "Update.js download"],
                weight=0.9
            ),
            BehavioralIndicator(
                name="Compromised Website Injection",
                description="Malicious JavaScript injected into legitimate sites",
                iocs=["malicious JS on legitimate domain", "drive-by download"],
                weight=0.85
            ),
        ],

        languages=["JavaScript", "PowerShell"],
        attack_vectors=["Compromised websites (WordPress vulns)"],
        persistence_methods=["Scheduled task"],
        evasion_techniques=["Fingerprinting (filters bots/sandboxes)", "Living off the land"],

        file_extensions=[".js", ".zip"],
        registry_keys=[],
        network_iocs=["evil-server.com", "PowerShell C2 beacons"],
        process_names=["wscript.exe", "powershell.exe"],

        initial_access="Drive-by download (fake browser update)",
        execution="JavaScript via wscript.exe",
        persistence="Scheduled task or registry",
        privilege_escalation="N/A",
        defense_evasion="Fileless (PowerShell), fingerprinting",
        credential_access="N/A (initial access only)",
        discovery="System profiling sent to C2",
        lateral_movement="N/A",
        collection="System information",
        exfiltration="Profile sent to C2",
        impact="Downloads Stage 2: RansomHub, LockBit, Cobalt Strike, RATs"
    ),

    # ========================================================================
    # CRYPTOMINERS
    # ========================================================================

    "CoinMiner": MalwareSignature(
        name="CoinMiner",
        aliases=["Cryptojacker", "XMRig"],
        category=ThreatCategory.CRYPTOMINER,
        severity=ThreatSeverity.MEDIUM,
        description="Hijacks CPU/GPU for cryptocurrency mining, fileless variants",

        behaviors=[
            BehavioralIndicator(
                name="High CPU Usage",
                description="Sustained 80-100% CPU usage",
                iocs=["maxed CPU", "thermal throttling", "loud fans"],
                weight=0.95
            ),
            BehavioralIndicator(
                name="Mining Pool Connections",
                description="Connects to known mining pools",
                iocs=["pool.minexmr.com", "xmr-pool connections"],
                weight=1.0
            ),
            BehavioralIndicator(
                name="Idle Mining",
                description="Only mines when user is idle (stealth mode)",
                iocs=["activity-based CPU spikes"],
                weight=0.7
            ),
        ],

        languages=["C++", "PowerShell"],
        attack_vectors=["Cracked software", "Drive-by downloads", "Malicious USB"],
        persistence_methods=["Scheduled tasks", "WMI Event Subscriptions"],
        evasion_techniques=["Fileless (PowerShell/WMI)", "Process name disguise", "Idle detection"],

        file_extensions=[],
        registry_keys=["HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"],
        network_iocs=["Mining pool traffic (Stratum protocol)", "Port 3333, 4444"],
        process_names=["svchost.exe", "conhost.exe", "services.exe"],

        initial_access="Bundled with cracked software, drive-by",
        execution="XMRig or similar miner",
        persistence="Scheduled task, WMI subscription",
        privilege_escalation="N/A",
        defense_evasion="Fileless, process disguise, idle mining",
        credential_access="N/A",
        discovery="CPU/GPU detection",
        lateral_movement="N/A",
        collection="N/A",
        exfiltration="Mined cryptocurrency to attacker wallet",
        impact="Resource theft, hardware damage, high electricity cost"
    ),

    # ========================================================================
    # LEGACY/FOUNDATIONAL THREATS
    # ========================================================================

    "WannaCry": MalwareSignature(
        name="WannaCry",
        aliases=["WannaCrypt", "WCry"],
        category=ThreatCategory.WORM,
        severity=ThreatSeverity.CRITICAL,
        description="2017 ransom-worm, EternalBlue exploit (MS17-010), global pandemic",

        behaviors=[
            BehavioralIndicator(
                name="EternalBlue Worm",
                description="Spreads via SMBv1 exploit (MS17-010)",
                iocs=["SMB Port 445 scanning", "EternalBlue exploit"],
                weight=1.0
            ),
            BehavioralIndicator(
                name="Kill Switch Domain",
                description="Checks for kill switch domain before execution",
                iocs=["DNS query to iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com"],
                weight=0.95
            ),
        ],

        languages=["C++"],
        attack_vectors=["SMBv1 exploitation"],
        persistence_methods=["Service creation"],
        evasion_techniques=["Kill switch (anti-sandbox)"],

        file_extensions=[".WCRY", ".WNCRY"],
        registry_keys=[],
        network_iocs=["Port 445 scanning", "Tor C2", "Bitcoin wallet addresses"],
        process_names=["tasksche.exe", "mssecsvc.exe"],

        initial_access="EternalBlue exploit (SMBv1)",
        execution="Worm payload",
        persistence="Service creation",
        privilege_escalation="SYSTEM via EternalBlue",
        defense_evasion="Kill switch check",
        credential_access="N/A",
        discovery="Network scanning for SMB",
        lateral_movement="Worm propagation via EternalBlue",
        collection="N/A",
        exfiltration="N/A",
        impact="File encryption, global infrastructure disruption (NHS)"
    ),

    "NotPetya": MalwareSignature(
        name="NotPetya",
        aliases=["Petya", "ExPetr", "GoldenEye"],
        category=ThreatCategory.WIPER,
        severity=ThreatSeverity.CRITICAL,
        description="2017 wiper disguised as ransomware, MBR destruction, $10B damage",

        behaviors=[
            BehavioralIndicator(
                name="Supply Chain (M.E.Doc)",
                description="Spread via trojanized tax software update",
                iocs=["M.E.Doc update", "Ukrainian tax software"],
                weight=1.0
            ),
            BehavioralIndicator(
                name="Dual Worm (EternalBlue + Mimikatz)",
                description="Uses EternalBlue AND stolen credentials",
                iocs=["EternalBlue + Mimikatz combo", "PsExec lateral movement"],
                weight=1.0
            ),
            BehavioralIndicator(
                name="MBR Wiper",
                description="Destroys Master Boot Record (permanent damage)",
                iocs=["MBR overwrite", "fake ransom note", "unrecoverable"],
                weight=1.0
            ),
        ],

        languages=["C++"],
        attack_vectors=["Supply chain (M.E.Doc trojanized update)"],
        persistence_methods=["MBR infection"],
        evasion_techniques=["Fake ransomware cover"],

        file_extensions=[],
        registry_keys=[],
        network_iocs=["EternalBlue scanning", "PsExec traffic"],
        process_names=["perfc.dat", "rundll32.exe"],

        initial_access="Supply chain compromise (M.E.Doc)",
        execution="Malicious DLL",
        persistence="MBR infection",
        privilege_escalation="Mimikatz for admin creds",
        defense_evasion="Fake ransomware narrative",
        credential_access="Mimikatz",
        discovery="Network scanning",
        lateral_movement="EternalBlue + PsExec + WMI with stolen creds",
        collection="N/A",
        exfiltration="N/A",
        impact="MBR wiper (permanent data destruction), $10B global damage"
    ),

    "Stuxnet": MalwareSignature(
        name="Stuxnet",
        aliases=[],
        category=ThreatCategory.CYBERWEAPON,
        severity=ThreatSeverity.CRITICAL,
        description="2010 cyber-weapon, targets ICS/SCADA, physical sabotage of centrifuges",

        behaviors=[
            BehavioralIndicator(
                name="USB Propagation",
                description="Spreads via infected USB drives (LNK exploit)",
                iocs=["LNK vulnerability CVE-2010-2568", "USB autorun"],
                weight=0.9
            ),
            BehavioralIndicator(
                name="PLC Payload",
                description="Targets Siemens Step7 PLCs",
                iocs=["Siemens Step7 detection", "PLC code injection"],
                weight=1.0
            ),
            BehavioralIndicator(
                name="Stolen Certificates",
                description="Signed with stolen Realtek and JMicron certificates",
                iocs=["Realtek cert", "JMicron cert"],
                weight=0.95
            ),
        ],

        languages=["C++"],
        attack_vectors=["Infected USB drives"],
        persistence_methods=["Rootkit"],
        evasion_techniques=["Stolen digital signatures", "Rootkit", "Surgical targeting"],

        file_extensions=[],
        registry_keys=[],
        network_iocs=["None (air-gapped target)"],
        process_names=[],

        initial_access="Infected USB drive (LNK exploit)",
        execution="Multi-stage malware",
        persistence="Rootkit",
        privilege_escalation="4 zero-days",
        defense_evasion="Stolen certificates, rootkit",
        credential_access="N/A",
        discovery="Siemens Step7 software detection",
        lateral_movement="Network worm (MS08-067)",
        collection="N/A",
        exfiltration="N/A",
        impact="Physical sabotage (centrifuge destruction via PLC manipulation)"
    ),

    "Zeus": MalwareSignature(
        name="Zeus",
        aliases=["Zbot", "Gameover ZeuS"],
        category=ThreatCategory.TROJAN,
        severity=ThreatSeverity.HIGH,
        description="Banking trojan, Man-in-the-Browser, form grabbing, P2P botnet (GOZ)",

        behaviors=[
            BehavioralIndicator(
                name="Man-in-the-Browser",
                description="Injects code into browser to steal credentials",
                iocs=["browser hooking", "form grabbing", "HTML injection"],
                weight=1.0
            ),
            BehavioralIndicator(
                name="Banking Site Targeting",
                description="Activates when user visits banking websites",
                iocs=["monitors for bank URLs", "fake security prompts"],
                weight=0.95
            ),
        ],

        languages=["C++"],
        attack_vectors=["Phishing", "Drive-by downloads"],
        persistence_methods=["Registry", "Service"],
        evasion_techniques=["Rootkit", "Encryption"],

        file_extensions=[],
        registry_keys=["HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"],
        network_iocs=["C2 traffic", "P2P botnet (Gameover ZeuS)"],
        process_names=["sdra64.exe"],

        initial_access="Phishing, drive-by download",
        execution="Trojan executable",
        persistence="Registry, service",
        privilege_escalation="Rootkit",
        defense_evasion="Rootkit, encryption",
        credential_access="Form grabbing, keylogging, screenshots",
        discovery="Browser detection",
        lateral_movement="N/A",
        collection="Banking credentials, PINs, CVVs",
        exfiltration="C2 channel, P2P botnet",
        impact="Financial theft, CryptoLocker distribution (Gameover ZeuS)"
    ),
}


# ============================================================================
# AI-POWERED THREAT BEHAVIORAL SIGNATURES
# ============================================================================

AI_POWERED_THREATS = {

    "AI_Polymorphic_Malware": {
        "name": "AI-Generated Polymorphic Code",
        "description": "Malware that uses LLM API to rewrite itself every hour",
        "example": "PROMPTFLUX, BlackMamba",
        "behaviors": [
            {
                "name": "LLM API Calls",
                "iocs": ["api.gemini.google.com", "api.openai.com", "api.anthropic.com"],
                "weight": 0.95
            },
            {
                "name": "Code Self-Modification",
                "iocs": ["script rewrites itself", "hash changes hourly"],
                "weight": 0.9
            },
            {
                "name": "Obfuscation Prompts",
                "iocs": ["'rewrite this code'", "'obfuscate'", "'functionally identical'"],
                "weight": 0.85
            },
        ]
    },

    "AI_Phishing": {
        "name": "AI-Powered Spear Phishing",
        "description": "LLM-generated personalized phishing using OSINT",
        "example": "WormGPT, FraudGPT campaigns",
        "behaviors": [
            {
                "name": "Hyper-Personalization",
                "iocs": ["references specific projects", "mentions recent events", "perfect grammar"],
                "weight": 0.7
            },
            {
                "name": "Multi-Modal Attack",
                "iocs": ["email + voice call", "deepfake video conference"],
                "weight": 0.9
            },
            {
                "name": "Over-Personalization",
                "iocs": ["unnatural detail level", "tries too hard to prove legitimacy"],
                "weight": 0.75
            },
        ]
    },

    "Autonomous_Lateral_Movement": {
        "name": "Agentic AI Attacker",
        "description": "AI agent that autonomously navigates network to find crown jewels",
        "example": "GTG-1002 campaign",
        "behaviors": [
            {
                "name": "Autonomous Decision-Making",
                "iocs": ["unique, never-seen-before attack paths", "evades honeypots"],
                "weight": 0.95
            },
            {
                "name": "Machine-Speed Execution",
                "iocs": ["full kill chain in <10 seconds", "simultaneous multi-host"],
                "weight": 1.0
            },
            {
                "name": "Context-Aware Targeting",
                "iocs": ["finds high-value data without instructions", "parses AD structure"],
                "weight": 0.9
            },
        ]
    },

    "AI_Vuln_Discovery": {
        "name": "AI-Driven Zero-Day Hunting",
        "description": "AI scans code for vulnerabilities before defenders",
        "example": "Big Sleep (defensive), attacker variants",
        "behaviors": [
            {
                "name": "Automated Code Scanning",
                "iocs": ["GitHub scraping", "GitLab access", "code repository enumeration"],
                "weight": 0.8
            },
            {
                "name": "Smart Fuzzing",
                "iocs": ["evolutionary fuzzing patterns", "learns from each attempt"],
                "weight": 0.85
            },
        ]
    },

    "Adversarial_Evasion": {
        "name": "Adversarial AI Evasion",
        "description": "Malware designed to fool defensive AI",
        "example": "Adversarial examples, prompt injection",
        "behaviors": [
            {
                "name": "Prompt Injection in Code",
                "iocs": ["hidden [SYSTEM_NOTE] in comments", "AI instruction override"],
                "weight": 0.95
            },
            {
                "name": "Byte-Level Adversarial Examples",
                "iocs": ["single-byte flips", "maintains function but changes signature"],
                "weight": 0.9
            },
            {
                "name": "Data Poisoning Attempt",
                "iocs": ["submits mislabeled samples", "supply chain compromise of datasets"],
                "weight": 0.85
            },
        ]
    },
}


# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

def get_malware_by_category(category: ThreatCategory) -> List[MalwareSignature]:
    """Get all malware of a specific category"""
    return [
        malware for malware in MALWARE_DATABASE.values()
        if malware.category == category
    ]


def get_critical_threats() -> List[MalwareSignature]:
    """Get all CRITICAL severity threats"""
    return [
        malware for malware in MALWARE_DATABASE.values()
        if malware.severity == ThreatSeverity.CRITICAL
    ]


def search_by_behavior(behavior_name: str) -> List[str]:
    """Find malware families that exhibit a specific behavior"""
    matches = []
    for name, malware in MALWARE_DATABASE.items():
        for behavior in malware.behaviors:
            if behavior_name.lower() in behavior.name.lower():
                matches.append(name)
                break
    return matches


def get_malware_info(name: str) -> MalwareSignature:
    """Get full signature for a malware family"""
    return MALWARE_DATABASE.get(name)


# ============================================================================
# SUMMARY STATISTICS
# ============================================================================

def print_database_stats():
    """Print statistics about the malware database"""
    print("\n" + "="*70)
    print("üõ°Ô∏è  AEGIS MALWARE SIGNATURE DATABASE")
    print("="*70)

    total = len(MALWARE_DATABASE)
    print(f"\nüìä Total Signatures: {total}")

    print(f"\nüìÅ By Category:")
    for category in ThreatCategory:
        count = len(get_malware_by_category(category))
        print(f"   {category.value.upper()}: {count}")

    print(f"\nüî• By Severity:")
    for severity in ThreatSeverity:
        count = len([m for m in MALWARE_DATABASE.values() if m.severity == severity])
        print(f"   {severity.name}: {count}")

    critical = get_critical_threats()
    print(f"\n‚ö†Ô∏è  CRITICAL Threats ({len(critical)}):")
    for threat in critical:
        print(f"   ‚Ä¢ {threat.name}: {threat.description[:60]}...")

    print(f"\nü§ñ AI-Powered Threats: {len(AI_POWERED_THREATS)}")
    for name, threat in AI_POWERED_THREATS.items():
        print(f"   ‚Ä¢ {threat['name']}")

    print("\n" + "="*70 + "\n")


if __name__ == "__main__":
    print_database_stats()
