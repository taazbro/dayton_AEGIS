#!/bin/bash

# ============================================
# AEGIS Autonomous Git Sync
# Automatically commits and pushes changes
# while keeping secrets encrypted
# ============================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
BRANCH="${GIT_BRANCH:-main}"
SYNC_INTERVAL="${SYNC_INTERVAL:-300}"  # 5 minutes default

echo -e "${BLUE}============================================${NC}"
echo -e "${BLUE}üî• AEGIS Autonomous Git Sync${NC}"
echo -e "${BLUE}============================================${NC}"
echo ""

cd "$REPO_DIR"

# Check if git repo
if [ ! -d ".git" ]; then
    echo -e "${RED}‚ùå Not a git repository${NC}"
    exit 1
fi

# Function to encrypt secrets before commit
encrypt_secrets() {
    echo -e "${YELLOW}üîí Encrypting secrets...${NC}"

    if [ -f ".env" ] && [ -n "$AEGIS_MASTER_PASSWORD" ]; then
        python3 tools/secrets_manager.py encrypt-env
        git add .env.encrypted
        echo -e "${GREEN}‚úì Secrets encrypted${NC}"
    else
        if [ ! -f ".env" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  No .env file found${NC}"
        fi
        if [ -z "$AEGIS_MASTER_PASSWORD" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  AEGIS_MASTER_PASSWORD not set, skipping encryption${NC}"
        fi
    fi
}

# Function to check for changes
has_changes() {
    git diff --quiet && git diff --staged --quiet
    return $?
}

# Function to auto-commit and push
auto_sync() {
    echo -e "${BLUE}üìä Checking for changes...${NC}"

    # Check if there are changes
    if has_changes; then
        echo -e "${YELLOW}üìù Changes detected${NC}"

        # Encrypt secrets first
        encrypt_secrets

        # Add all files (respecting .gitignore)
        git add -A

        # Generate commit message
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
        COMMIT_MSG="ü§ñ Auto-sync: ${TIMESTAMP}

Auto-committed changes:
$(git status --short | head -10)

üî• Generated by AEGIS Autonomous Sync"

        # Commit
        echo -e "${GREEN}üíæ Committing changes...${NC}"
        git commit -m "$COMMIT_MSG"

        # Push
        echo -e "${GREEN}‚¨ÜÔ∏è  Pushing to GitHub...${NC}"
        if git push origin "$BRANCH"; then
            echo -e "${GREEN}‚úì Successfully pushed to GitHub${NC}"
        else
            echo -e "${RED}‚ùå Push failed${NC}"
            return 1
        fi
    else
        echo -e "${BLUE}‚úì No changes to sync${NC}"
    fi
}

# Function to run continuous sync
continuous_sync() {
    echo -e "${GREEN}üîÑ Starting continuous sync (every ${SYNC_INTERVAL}s)${NC}"
    echo -e "${YELLOW}Press CTRL+C to stop${NC}"
    echo ""

    while true; do
        auto_sync
        echo ""
        echo -e "${BLUE}‚è∞ Next sync in ${SYNC_INTERVAL}s...${NC}"
        sleep "$SYNC_INTERVAL"
    done
}

# Main
case "${1:-once}" in
    once)
        auto_sync
        ;;
    continuous)
        continuous_sync
        ;;
    watch)
        continuous_sync
        ;;
    *)
        echo "Usage: $0 [once|continuous|watch]"
        echo ""
        echo "  once       - Sync once and exit (default)"
        echo "  continuous - Keep syncing every ${SYNC_INTERVAL}s"
        echo "  watch      - Alias for continuous"
        exit 1
        ;;
esac
